<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fiches CSR - Projet Natran</title>
    <link rel="icon" type="image/png"
        href="https://upload.wikimedia.org/wikipedia/fr/thumb/3/36/Logo_NaTran.svg/langfr-560px-Logo_NaTran.svg.png">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="app">

        <!-- ============= SIDEBAR ============= -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-circle">CSR</div>
                <div class="logo-text">
                    <h1>CSR Pilot</h1>
                    <span>Pyro-gazéification</span>
                </div>
            </div>

            <nav class="side-nav">
                <button class="side-nav-item" onclick="window.location.href='index.html'">Dashboard</button>
                <button class="side-nav-item"
                    onclick="window.location.href='pre-traitement.html'">Pré-traitement</button>
                <button class="side-nav-item" onclick="window.location.href='reacteur.html'">Réacteur</button>
                <button class="side-nav-item" onclick="window.location.href='emissions.html'">Émissions</button>
                <button class="side-nav-item" onclick="window.location.href='rapports.html'">Rapports</button>
                <button class="side-nav-item active" onclick="window.location.href='fiches-csr.html'">Fiches
                    CSR</button>
            </nav>
        </aside>

        <!-- ============= MAIN ============= -->
        <main class="main">

            <!-- ======= TOPBAR ======= -->
            <header class="topbar">
                <div class="top-left">
                    <h2>Fiches d'identité Énergétique CSR</h2>
                </div>

                <div class="top-right">
                    <div class="user">
                        <img src="https://upload.wikimedia.org/wikipedia/fr/thumb/3/36/Logo_NaTran.svg/langfr-560px-Logo_NaTran.svg.png"
                            alt="Logo Natran" class="user-avatar">
                        <div>
                            <div class="user-name">Selyan MOUHALI</div>
                            <div class="user-role">Opérateur unité pilote</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ======= CONTENT ======= -->
            <section class="grid" id="batches-grid">
                <!-- Les cartes seront injectées ici par JS -->
                <div class="card card-wide">
                    <div class="card-body">
                        <p>Chargement des fiches...</p>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // Navigation logic (simplified for this page)
        document.querySelectorAll('.side-nav-item').forEach(btn => {
            btn.addEventListener('click', (e) => {
                // Handled by onclick in HTML for simplicity or navigation.js if included
            });
        });

        // Fetch and display batches
        async function fetchBatches() {
            try {
                const res = await fetch('/api/batches');
                if (!res.ok) throw new Error('Erreur API');
                const batches = await res.json();
                renderBatches(batches);
            } catch (err) {
                console.error(err);
                document.getElementById('batches-grid').innerHTML = '<p>Impossible de charger les fiches CSR.</p>';
            }
        }

        function renderBatches(batches) {
            const container = document.getElementById('batches-grid');
            container.innerHTML = '';

            if (batches.length === 0) {
                container.innerHTML = '<p>Aucune fiche CSR disponible.</p>';
                return;
            }

            batches.forEach(batch => {
                const card = document.createElement('article');
                card.className = 'card';

                // Calculate Quality (Mock logic)
                let qualityClass = 'neutral';
                let qualityText = 'Standard';
                if (batch.pci > 20) {
                    qualityClass = 'good';
                    qualityText = 'Excellente';
                } else if (batch.pci < 15) {
                    qualityClass = 'warn';
                    qualityText = 'Moyenne';
                }

                // Format pollutants
                let pollutantsHtml = '';
                for (const [key, val] of Object.entries(batch.pollutants)) {
                    let colorClass = 'neutral';
                    if (val > 1.0) colorClass = 'warn'; // Example threshold
                    pollutantsHtml += `<span class="tag ${colorClass}">${key}: ${val}%</span>`;
                }

                // Helper for progress bars
                const renderProgress = (label, value, max = 100, unit = '%') => {
                    const pct = (value / max) * 100;
                    let color = 'var(--accent)';
                    if (label === 'Humidité') {
                        color = value < 15 ? '#2ecc71' : (value < 25 ? '#f1c40f' : '#e74c3c');
                    }
                    return `
                        <div class="progress-item">
                            <div class="progress-label">
                                <span>${label}</span>
                                <strong>${value}${unit}</strong>
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill" style="width: ${pct}%; background: ${color};"></div>
                            </div>
                        </div>
                    `;
                };

                card.innerHTML = `
                <header class="card-header">
                    <div>
                        <div style="display:flex; align-items:center; gap:8px;">
                            <h3>${batch.name || 'CSR Standard'}</h3>
                            <span class="tag ${qualityClass}" style="font-size:0.7rem; padding:2px 8px;">${qualityText}</span>
                        </div>
                        <span class="small-text">${batch.batch_ref}</span>
                    </div>
                    <span class="pill">${new Date(batch.created_at).toLocaleDateString()}</span>
                </header>
                
                <div class="card-body">
                    
                    <!-- Section Physico-chimique -->
                    <div class="section-title">Physico-chimique</div>
                    <div class="kpi-grid-2">
                        <div class="kpi-box">
                            <span class="label">PCI</span>
                            <span class="value">${batch.pci} <small>MJ/kg</small></span>
                        </div>
                        <div class="kpi-box">
                            <span class="label">Granulo.</span>
                            <span class="value">${batch.granulometry} <small>mm</small></span>
                        </div>
                    </div>
                    ${renderProgress('Humidité', batch.humidity)}

                    <hr class="divider">

                    <!-- Section Élémentaire -->
                    <div class="section-title">Analyse Élémentaire</div>
                    <div class="syngas-grid">
                        <div class="syngas-item">
                            <span>C</span>
                            <strong>${batch.carbon}%</strong>
                            <div class="mini-bar"><div style="width:${batch.carbon}%; background:#555;"></div></div>
                        </div>
                        <div class="syngas-item">
                            <span>H</span>
                            <strong>${batch.hydrogen}%</strong>
                            <div class="mini-bar"><div style="width:${batch.hydrogen * 5}%; background:#3498db;"></div></div>
                        </div>
                        <div class="syngas-item">
                            <span>O</span>
                            <strong>${batch.oxygen}%</strong>
                            <div class="mini-bar"><div style="width:${batch.oxygen * 2}%; background:#e74c3c;"></div></div>
                        </div>
                    </div>

                    <hr class="divider">

                    <!-- Section Polluants -->
                    <div class="section-title">Polluants & Résidus</div>
                    <div class="tags-col" style="flex-direction: row; flex-wrap: wrap;">
                        ${pollutantsHtml}
                    </div>
                </div>
            `;
                container.appendChild(card);
            });
        }

        document.addEventListener('DOMContentLoaded', fetchBatches);
    </script>

</body>

</html>