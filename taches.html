<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes T√¢ches - Projet Natran</title>
    <link rel="icon" type="image/png"
        href="https://upload.wikimedia.org/wikipedia/fr/thumb/3/36/Logo_NaTran.svg/langfr-560px-Logo_NaTran.svg.png">
    <link rel="stylesheet" href="style.css">
    <style>
        .tasks-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            height: 100%;
        }

        .task-column {
            background: #f8f8fb;
            border-radius: var(--radius-lg);
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .column-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 12px;
            border-bottom: 2px solid #ececf0;
            margin-bottom: 8px;
        }

        .column-title {
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .count-badge {
            background: #e3e4ea;
            color: var(--text-muted);
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 999px;
        }

        .task-card {
            background: #fff;
            border-radius: var(--radius-md);
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            cursor: pointer;
            transition: transform 0.2s;
            border-left: 4px solid transparent;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .task-card.high {
            border-left-color: #e74c3c;
        }

        .task-card.medium {
            border-left-color: #f1c40f;
        }

        .task-card.low {
            border-left-color: #2ecc71;
        }

        .task-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .priority-tag {
            text-transform: uppercase;
            font-weight: 700;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .high .priority-tag {
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .medium .priority-tag {
            color: #f1c40f;
            background: rgba(241, 196, 15, 0.1);
        }

        .low .priority-tag {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
    </style>
</head>

<body>

    <div class="app">

        <!-- ============= SIDEBAR ============= -->
        <aside class="sidebar">
            <div class="logo">
                <div class="logo-circle">CSR</div>
                <div class="logo-text">
                    <h1>CSR Pilot</h1>
                    <span>Pyro-gaz√©ification</span>
                </div>
            </div>

            <nav class="side-nav">
                <button class="side-nav-item" onclick="window.location.href='index.html'">Dashboard</button>
                <button class="side-nav-item"
                    onclick="window.location.href='pre-traitement.html'">Pr√©-traitement</button>
                <button class="side-nav-item" onclick="window.location.href='reacteur.html'">R√©acteur</button>
                <button class="side-nav-item" onclick="window.location.href='emissions.html'">√âmissions</button>
                <button class="side-nav-item" onclick="window.location.href='fiches-csr.html'">Fiches CSR</button>
            </nav>
        </aside>

        <!-- ============= MAIN ============= -->
        <main class="main">

            <!-- ======= TOPBAR ======= -->
            <header class="topbar">
                <div class="top-left">
                    <h2>Mes T√¢ches</h2>
                </div>

                <div class="top-right">
                    <div class="user">
                        <img src="https://upload.wikimedia.org/wikipedia/fr/thumb/3/36/Logo_NaTran.svg/langfr-560px-Logo_NaTran.svg.png"
                            alt="Logo Natran" class="user-avatar">
                        <div>
                            <div class="user-name">Selyan MOUHALI</div>
                            <div class="user-role">Op√©rateur unit√© pilote</div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- ======= CONTENT ======= -->
            <div style="margin-bottom: 20px; text-align: right;">
                <button class="primary-btn small" onclick="openModal()">+ Nouvelle T√¢che</button>
            </div>

            <div class="tasks-container">

                <!-- TODO -->
                <div class="task-column" id="col-todo">
                    <div class="column-header">
                        <div class="column-title">
                            <span style="color: #e74c3c;">‚óè</span> √Ä faire
                        </div>
                        <span class="count-badge" id="count-todo">0</span>
                    </div>
                    <!-- Tasks injected here -->
                </div>

                <!-- DOING -->
                <div class="task-column" id="col-doing">
                    <div class="column-header">
                        <div class="column-title">
                            <span style="color: #f1c40f;">‚óè</span> En cours
                        </div>
                        <span class="count-badge" id="count-doing">0</span>
                    </div>
                    <!-- Tasks injected here -->
                </div>

                <!-- DONE -->
                <div class="task-column" id="col-done">
                    <div class="column-header">
                        <div class="column-title">
                            <span style="color: #2ecc71;">‚óè</span> Termin√©
                        </div>
                        <span class="count-badge" id="count-done">0</span>
                    </div>
                    <!-- Tasks injected here -->
                </div>

            </div>

        </main>
    </div>

    <!-- MODAL -->
    <div id="task-modal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h3 id="modal-title">Nouvelle T√¢che</h3>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label>Titre</label>
                    <input type="text" id="input-title" required class="form-input">
                </div>
                <div class="form-group">
                    <label>Priorit√©</label>
                    <select id="input-priority" class="form-input">
                        <option value="low">Basse</option>
                        <option value="medium" selected>Moyenne</option>
                        <option value="high">Haute</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Statut</label>
                    <select id="input-status" class="form-input">
                        <option value="todo">√Ä faire</option>
                        <option value="doing">En cours</option>
                        <option value="done">Termin√©</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date d'√©ch√©ance</label>
                    <input type="date" id="input-date" class="form-input">
                </div>
                <div class="modal-actions">
                    <button type="button" class="ghost-btn" onclick="closeModal()">Annuler</button>
                    <button type="submit" class="primary-btn small">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: #fff;
            padding: 24px;
            border-radius: 16px;
            width: 400px;
            max-width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85rem;
            color: #666;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 24px;
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            justify-content: flex-end;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .task-card:hover .task-actions {
            opacity: 1;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px;
            color: #888;
        }

        .action-btn:hover {
            color: var(--accent);
        }
    </style>

    <script>
        let currentTasks = [];

        async function fetchTasks() {
            try {
                const res = await fetch(`/api/tasks?t=${Date.now()}`);
                if (!res.ok) throw new Error('Erreur API');
                currentTasks = await res.json();
                renderTasks(currentTasks);
            } catch (err) {
                console.error(err);
            }
        }

        function renderTasks(tasks) {
            const cols = {
                todo: document.getElementById('col-todo'),
                doing: document.getElementById('col-doing'),
                done: document.getElementById('col-done')
            };
            const counts = { todo: 0, doing: 0, done: 0 };

            // Clear existing (keep headers)
            Object.values(cols).forEach(col => {
                while (col.children.length > 1) {
                    col.removeChild(col.lastChild);
                }
            });

            tasks.forEach(task => {
                const col = cols[task.status];
                if (col) {
                    counts[task.status]++;
                    const card = document.createElement('div');
                    card.className = `task-card ${task.priority}`;
                    card.innerHTML = `
                    <div style="font-weight: 600; font-size: 0.9rem;">${task.title}</div>
                    <div class="task-meta">
                        <span>üìÖ ${new Date(task.due_date).toLocaleDateString()}</span>
                        <span class="priority-tag">${task.priority}</span>
                    </div>
                    <div class="task-actions">
                        <button class="action-btn" onclick="editTask(${task.id})">‚úèÔ∏è</button>
                        <button class="action-btn" onclick="deleteTask(${task.id})">üóëÔ∏è</button>
                    </div>
                `;
                    col.appendChild(card);
                }
            });

            document.getElementById('count-todo').textContent = counts.todo;
            document.getElementById('count-doing').textContent = counts.doing;
            document.getElementById('count-done').textContent = counts.done;
        }

        // --- MODAL & CRUD ---

        function openModal(taskId = null) {
            const modal = document.getElementById('task-modal');
            const form = document.getElementById('task-form');
            const title = document.getElementById('modal-title');

            if (taskId) {
                const task = currentTasks.find(t => t.id === taskId);
                document.getElementById('task-id').value = task.id;
                document.getElementById('input-title').value = task.title;
                document.getElementById('input-priority').value = task.priority;
                document.getElementById('input-status').value = task.status;
                document.getElementById('input-date').value = task.due_date ? task.due_date.split('T')[0] : '';
                title.textContent = "Modifier la t√¢che";
            } else {
                form.reset();
                document.getElementById('task-id').value = '';
                document.getElementById('input-date').value = new Date().toISOString().split('T')[0];
                title.textContent = "Nouvelle T√¢che";
            }

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('task-modal').style.display = 'none';
        }

        function editTask(id) {
            openModal(id);
        }

        async function deleteTask(id) {
            if (!confirm("Supprimer cette t√¢che ?")) return;
            try {
                await fetch(`/api/tasks/${id}`, { method: 'DELETE' });
                fetchTasks();
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('task-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('task-id').value;
            const data = {
                title: document.getElementById('input-title').value,
                priority: document.getElementById('input-priority').value,
                status: document.getElementById('input-status').value,
                due_date: document.getElementById('input-date').value
            };

            try {
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/tasks/${id}` : '/api/tasks';

                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                closeModal();
                fetchTasks();
            } catch (err) {
                console.error(err);
            }
        });

        document.addEventListener('DOMContentLoaded', fetchTasks);
    </script>

</body>

</html>